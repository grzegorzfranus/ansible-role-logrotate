---
# =============================================================================
# Ansible Role: Chrony - System Prerequisites
# =============================================================================
# This file contains tasks for checking and configuring system prerequisites.
# It ensures that conflicting time synchronization services are stopped and disabled.
#
# Flow:
# 1. NTP Service Management
# 2. Systemd-timesyncd Service Management
# =============================================================================

# -----------------------------------------------------------------------------
# 1. NTP Service Management
# -----------------------------------------------------------------------------
- name: 🔍 Chrony | prerequisites | Check if NTP service exists
  ansible.builtin.systemd:
    name: "{{ chrony_ntp_service_name }}"
  register: _ntp_service_check_
  failed_when: false
  check_mode: true

- name: 🛑 Chrony | prerequisites | Stop and disable NTP service if running
  become: true
  ansible.builtin.systemd:
    name: "{{ chrony_ntp_service_name }}"
    state: stopped
    enabled: false
    daemon_reload: true
  when: >
    not ansible_check_mode and
    _ntp_service_check_.status is defined and
    _ntp_service_check_.status.ActiveState in ['active', 'activating']

# -----------------------------------------------------------------------------
# 2. Systemd-timesyncd Service Management
# -----------------------------------------------------------------------------
- name: 🔍 Chrony | prerequisites | Check if systemd-timesyncd service exists
  ansible.builtin.systemd:
    name: "{{ chrony_systemd_timesyncd_service_name }}"
  register: _systemd_timesyncd_service_check_
  failed_when: false
  check_mode: true

- name: 🛑 Chrony | prerequisites | Stop and disable systemd-timesyncd service if running
  become: true
  ansible.builtin.systemd:
    name: "{{ chrony_systemd_timesyncd_service_name }}"
    state: stopped
    enabled: false
    daemon_reload: true
  when: >
    not ansible_check_mode and
    _systemd_timesyncd_service_check_.status is defined and
    _systemd_timesyncd_service_check_.status.ActiveState in ['active', 'activating']
